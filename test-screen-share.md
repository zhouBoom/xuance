# 屏幕共享功能验证指南

## 🔧 测试准备

### 1. 启动信令服务器
```bash
# 安装依赖
npm install ws

# 启动测试信令服务器
node signal-server-test.js
```

### 2. 配置环境变量
在项目根目录的 `.env` 文件中配置：
```bash
SIGNAL_SERVER_URL=ws://localhost:8080
REMOTE_CONTROL_AUTO_START=true
```

## 📋 验证清单

### ✅ **基础功能验证**

#### 1. 屏幕源检测
- [ ] 打开开发者工具，查看控制台日志
- [ ] 确认能检测到可用的屏幕源（显示器和窗口）
- [ ] 验证日志输出：`可用显示器: X 个`、`可用窗口: Y 个`

#### 2. 屏幕捕获验证
- [ ] 确认选择了正确的屏幕源（优先选择显示器）
- [ ] 验证日志：`屏幕捕获成功, 流 ID: xxx`
- [ ] 检查是否有错误：`屏幕捕获失败`

#### 3. WebRTC连接验证
- [ ] 检查 PeerConnection 创建：`RTCPeerConnection 创建成功`
- [ ] 验证屏幕流添加：`屏幕流已添加到 PeerConnection`
- [ ] 监控连接状态：`WebRTC 连接状态变化: connected/connecting/failed`

### 🌐 **网络连接验证**

#### 4. 信令服务器连接
- [ ] 验证连接成功：`信令服务器连接成功`
- [ ] 检查 WebSocket 状态：OPEN (1)
- [ ] 确认能收发信令消息

#### 5. SDP协商过程
- [ ] 确认 Offer 创建：`SDP Offer 已发送`
- [ ] 等待 Answer 响应：`SDP Answer 已设置`
- [ ] 验证 ICE 候选交换：`ICE Candidate 已添加`

### 🖱️ **鼠标控制验证**

#### 6. 数据通道建立
- [ ] 确认数据通道打开：`鼠标控制数据通道已打开`
- [ ] 验证数据通道状态：`open`
- [ ] 检查错误处理：`数据通道错误`

#### 7. 鼠标事件处理
- [ ] 模拟鼠标事件接收
- [ ] 验证 IPC 通信：`sendMouseEvent` 调用
- [ ] 检查错误处理：`处理鼠标事件失败`

### 🎨 **UI状态验证**

#### 8. 状态指示器
- [ ] 确认屏幕共享启动时显示绿色横幅
- [ ] 验证文字内容：`🖥️ 屏幕共享已启动，支持远程鼠标控制`
- [ ] 检查闪烁动画是否正常
- [ ] 确认停止时横幅消失

## 🔍 **详细测试步骤**

### 步骤1：启动应用前准备
1. 启动信令服务器：`node signal-server-test.js`
2. 确认服务器输出：`🎯 信令服务器运行在: ws://localhost:8080`
3. 访问健康检查：`http://localhost:8080/health`

### 步骤2：启动应用并触发屏幕共享
1. 启动 Electron 应用
2. 打开开发者工具（F12）
3. 在渲染进程中手动触发屏幕共享：
```javascript
// 在控制台执行
window.electronAPI.startScreenShare({
  signalServerUrl: 'ws://localhost:8080'
});
```

### 步骤3：监控日志输出
关注以下关键日志：
```
✅ 收到屏幕共享启动请求，屏幕源数量: X
✅ 选择显示器进行共享: Display X
✅ 屏幕捕获成功, 流 ID: xxx
✅ RTCPeerConnection 创建成功
✅ 信令服务器连接成功
✅ SDP Offer 已发送
✅ 屏幕共享启动成功
✅ 鼠标控制数据通道已打开
```

### 步骤4：验证网络通信
在信令服务器控制台查看：
```
✅ 客户端连接: xxxxx
📨 收到来自 xxxxx 的消息: offer
🔄 SDP Offer - 开始协商
```

### 步骤5：测试双向通信
如果有两个客户端，应该看到：
```
📤 消息已转发给 1 个客户端
✅ SDP Answer - 协商响应
🧊 ICE Candidate - 网络候选
```

## 🚨 **常见问题排查**

### 问题1：屏幕捕获失败
**现象：** `屏幕捕获失败: NotAllowedError`
**解决：** 
- 确保应用有屏幕录制权限
- Windows: 检查隐私设置中的屏幕录制权限
- macOS: 系统偏好设置 > 安全性与隐私 > 屏幕录制

### 问题2：信令服务器连接失败
**现象：** `信令服务器连接失败`
**解决：**
- 确认信令服务器正在运行
- 检查防火墙设置
- 验证 WebSocket URL 配置

### 问题3：WebRTC连接建立失败
**现象：** `WebRTC 连接状态变化: failed`
**解决：**
- 检查网络连接
- 验证 STUN 服务器可达性
- 确认防火墙允许 UDP 流量

### 问题4：数据通道无法打开
**现象：** 数据通道一直处于 `connecting` 状态
**解决：**
- 确认 WebRTC 连接已建立
- 检查是否有网络阻塞
- 验证双方都正确处理数据通道事件

## 📊 **性能测试**

### 延迟测试
1. 记录屏幕捕获到显示的延迟
2. 测试鼠标事件的响应时间
3. 监控 CPU 和内存使用率

### 稳定性测试
1. 长时间运行测试（30分钟+）
2. 网络中断恢复测试
3. 多次启动/停止循环测试

### 兼容性测试
1. 不同屏幕分辨率测试
2. 多显示器环境测试
3. 不同网络环境测试（WiFi/有线）

## 📈 **监控指标**

在开发者工具中监控：
- WebRTC 统计信息：`chrome://webrtc-internals`
- 网络请求状态
- 内存使用情况
- CPU 使用率

## ✅ **验收标准**

功能正常的标准：
1. ✅ 能够成功检测和选择屏幕源
2. ✅ 屏幕捕获无错误且流畅
3. ✅ WebRTC 连接能够建立并保持稳定
4. ✅ 信令消息正常收发
5. ✅ 数据通道正常工作
6. ✅ UI 状态正确显示
7. ✅ 鼠标事件能够正常传输
8. ✅ 资源能够正确清理 